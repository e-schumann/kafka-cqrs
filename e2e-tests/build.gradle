description = 'End-to-end tests among multiple services in local cloud instance'

apply plugin: 'groovy'
apply plugin: 'de.qaware.cloud.deployer'

sourceCompatibility = 1.8
targetCompatibility = 1.8

task e2eTests(type: Test, dependsOn: dockerImageCreationTasks()) {
    description = 'Runs end-to-end tests among multiple services in local cloud instance.'

    doFirst {
        println "Starting in Kubernetes"
        //TODO
        println "Starting in Kubernetes - done"
    }

    doLast {
        println "Stopping in Kubernetes"
        //TODO
        println "Stopping in Kubernetes - done"
    }
}

check.dependsOn e2eTests

def dockerImageCreationTasks() {
    services().collect { it.tasks.getByPath('createDockerImage') }
}

def services() {
    parent.subprojects.findAll { it.name.endsWith('-service') }
}

deployer {
    kubernetes {
        id = 'localkube'
        baseUrl = 'https://localhost'
        strategy = 'UPDATE' //REPLACE?
        namespace = 'test'
        auth {
            username = 'admin'
            password = 's3cr3t'
        }
        ssl {
            trustAll = true
        }
        files = [file('kubernetes-local.json')]
    }
}

dependencies {
    testCompile 'org.spockframework:spock-core:1.1-groovy-2.4'
}